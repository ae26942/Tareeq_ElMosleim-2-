const azkarData = {
    'azkar-sabah': {
        title: 'أذكار الصباح',
        azkar: [
            { text: 'بسم الله الرحمن الرحيم. قل هو الله أحد. الله الصمد. لم يلد ولم يولد. ولم يكن له كفواً أحد.', count: 3 },
            { text: 'بسم الله الرحمن الرحيم. قل أعوذ برب الفلق. من شر ما خلق. ومن شر غاسق إذا وقب. ومن شر النفاثات في العقد. ومن شر حاسد إذا حسد.', count: 3 },
            { text: 'بسم الله الرحمن الرحيم. قل أعوذ برب الناس. ملك الناس. إله الناس. من شر الوسواس الخناس. الذي يوسوس في صدور الناس. من الجنة والناس.', count: 3 },
            { text: 'أصبحنا وأصبح الملك لله، والحمد لله، لا إله إلا الله وحده لا شريك له، له الملك وله الحمد وهو على كل شيء قدير. رب أسألك خير ما في هذا اليوم وخير ما بعده، وأعوذ بك من شر ما في هذا اليوم وشر ما بعده. رب أعوذ بك من الكسل وسوء الكبر، رب أعوذ بك من عذاب في النار وعذاب في القبر.', count: 1 },
            { text: 'اللهم بك أصبحنا، وبك أمسينا، وبك نحيا، وبك نموت، وإليك النشور.', count: 1 },
            { text: 'اللهم أنت ربي لا إله إلا أنت، خلقتني وأنا عبدك، وأنا على عهدك ووعدك ما استطعت، أعوذ بك من شر ما صنعت، أبوء لك بنعمتك علي، وأبوء بذنبي فاغفر لي فإنه لا يغفر الذنوب إلا أنت.', count: 1 },
            { text: 'اللهم إني أصبحت أشهدك وأشهد حملة عرشك، وملائكتك، وجميع خلقك، أنك أنت الله لا إله إلا أنت وحدك لا شريك لك، وأن محمداً عبدك ورسولك.', count: 4 },
            { text: 'اللهم ما أصبح بي من نعمة أو بأحد من خلقك فمنك وحدك لا شريك لك، فلك الحمد ولك الشكر.', count: 1 },
            { text: 'اللهم عافني في بدني، اللهم عافني في سمعي، اللهم عافني في بصري، لا إله إلا أنت.', count: 3 },
            { text: 'حسبي الله لا إله إلا هو، عليه توكلت، وهو رب العرش العظيم.', count: 7 },
            { text: 'اللهم إني أسألك العفو والعافية في الدنيا والآخرة، اللهم إني أسألك العفو والعافية في ديني ودنياي وأهلي ومالي، اللهم استر عوراتي وآمن روعاتي، اللهم احفظني من بين يدي ومن خلفي وعن يميني وعن شمالي ومن فوقي، وأعوذ بعظمتك أن أغتال من تحتي.', count: 1 },
            { text: 'يا حي يا قيوم برحمتك أستغيث، أصلح لي شأني كله، ولا تكلني إلى نفسي طرفة عين.', count: 3 },
            { text: 'أصبحت بالله مؤمنا، وكفرت بالجبت والطاغوت، واستمسكت بالعروة الوثقى، لا انفصام لها، والله سميع عليم.', count: 1 },
            { text: 'رضيت بالله رباً، وبالإسلام ديناً، وبمحمد صلى الله عليه وسلم نبياً.', count: 3 },
            { text: 'سبحان الله وبحمده، عدد خلقه، ورضا نفسه، وزنة عرشه، ومداد كلماته.', count: 3 },
            { text: 'سبحان الله وبحمده، سبحان الله العظيم.', count: 100 },
        ]
    },
    'azkar-masaa': {
        title: 'أذكار المساء',
        azkar: [
            { text: 'بسم الله الرحمن الرحيم. قل هو الله أحد...', count: 3 },
            { text: 'بسم الله الرحمن الرحيم. قل أعوذ برب الفلق...', count: 3 },
            { text: 'بسم الله الرحمن الرحيم. قل أعوذ برب الناس...', count: 3 },
            { text: 'أمسينا وأمسى الملك لله، والحمد لله، لا إله إلا الله وحده لا شريك له، له الملك وله الحمد وهو على كل شيء قدير. رب أسألك خير ما في هذه الليلة وخير ما بعدها، وأعوذ بك من شر ما في هذه الليلة وشر ما بعدها. رب أعوذ بك من الكسل وسوء الكبر، رب أعوذ بك من عذاب في النار وعذاب في القبر.', count: 1 },
            { text: 'اللهم بك أمسينا، وبك أصبحنا، وبك نحيا، وبك نموت، وإليك المصير.', count: 1 },
            { text: 'اللهم أنت ربي لا إله إلا أنت، خلقتني وأنا عبدك، وأنا على عهدك ووعدك ما استطعت، أعوذ بك من شر ما صنعت، أبوء لك بنعمتك علي، وأبوء بذنبي فاغفر لي فإنه لا يغفر الذنوب إلا أنت.', count: 1 },
            { text: 'اللهم إني أمسيت أشهدك وأشهد حملة عرشك، وملائكتك، وجميع خلقك، أنك أنت الله لا إله إلا أنت وحدك لا شريك لك، وأن محمداً عبدك ورسولك.', count: 4 },
            { text: 'اللهم ما أمسى بي من نعمة أو بأحد من خلقك فمنك وحدك لا شريك لك، فلك الحمد ولك الشكر.', count: 1 },
            { text: 'اللهم عافني في بدني، اللهم عافني في سمعي، اللهم عافني في بصري، لا إله إلا أنت.', count: 3 },
            { text: 'حسبي الله لا إله إلا هو، عليه توكلت، وهو رب العرش العظيم.', count: 7 },
            { text: 'اللهم إني أسألك العفو والعافية في الدنيا والآخرة، اللهم إني أسألك العفو والعافية في ديني ودنياي وأهلي ومالي، اللهم استر عوراتي وآمن روعاتي، اللهم احفظني من بين يدي ومن خلفي وعن يميني وعن شمالي ومن فوقي، وأعوذ بعظمتك أن أغتال من تحتي.', count: 1 },
            { text: 'يا حي يا قيوم برحمتك أستغيث، أصلح لي شأني كله، ولا تكلني إلى نفسي طرفة عين.', count: 3 },
            { text: 'أمسينا بالله مؤمنين، وكفرنا بالجبت والطاغوت، واستمسكنا بالعروة الوثقى، لا انفصام لها، والله سميع عليم.', count: 1 },
            { text: 'رضيت بالله رباً، وبالإسلام ديناً، وبمحمد صلى الله عليه وسلم نبياً.', count: 3 },
            { text: 'سبحان الله وبحمده، عدد خلقه، ورضا نفسه، وزنة عرشه، ومداد كلماته.', count: 3 },
            { text: 'سبحان الله وبحمده، سبحان الله العظيم.', count: 100 },
        ]
    },
    'azkar-noom': {
        title: 'أذكار النوم',
        azkar: [
            { text: 'باسمك ربي وضعت جنبي، وبك أرفعه، فإن أمسكت نفسي فارحمها، وإن أرسلتها فاحفظها بما تحفظ به عبادك الصالحين.', count: 1 },
            { text: 'اللهم قني عذابك يوم تبعث عبادك.', count: 3 },
            { text: 'الحمد لله الذي أطعمنا وسقانا وكفانا وآوانا، فكم ممن لا كافي له ولا مؤوي.', count: 1 },
            { text: 'اللهم رب السماوات ورب الأرض ورب العرش العظيم، ربنا ورب كل شيء، فالق الحب والنوى، ومنزل التوراة والإنجيل والفرقان، أعوذ بك من شر كل شيء أنت آخذ بناصيته، اللهم أنت الأول فليس قبلك شيء، وأنت الآخر فليس بعدك شيء، وأنت الظاهر فليس فوقك شيء، وأنت الباطن فليس دونك شيء، اقض عنا الدين وأغننا من الفقر.', count: 1 },
        ]
    },
    'azkar-estikaaz': {
        title: 'أذكار الاستيقاظ',
        azkar: [
            { text: 'الحمد لله الذي أحيانا بعد ما أماتنا، وإليه النشور.', count: 1 },
            { text: 'لا إله إلا الله وحده لا شريك له، له الملك وله الحمد، وهو على كل شيء قدير.', count: 1 },
            { text: 'اللهم إني أسألك من خير هذا اليوم، وخير ما بعده، وأعوذ بك من شر هذا اليوم، وشر ما بعده.', count: 1 },
        ]
    },
    'azkar-ham': {
        title: 'أذكار الهم والحزن',
        azkar: [
            { text: 'اللهم إني عبدك، وابن عبدك، وابن أمتك، ناصيتي بيدك، ماض في حكمك، عدل في قضاؤك، أسألك بكل اسم هو لك، سميت به نفسك، أو أنزلته في كتابك، أو علمته أحداً من خلقك، أو استأثرت به في علم الغيب عندك، أن تجعل القرآن العظيم ربيع قلبي، ونور صدري، وجلاء حزني، وذهاب همي.', count: 1 },
            { text: 'اللهم إني أعوذ بك من الهم والحزن، وأعوذ بك من العجز والكسل، وأعوذ بك من الجبن والبخل، وأعوذ بك من غلبة الدين وقهر الرجال.', count: 1 },
            { text: 'لا إله إلا الله العظيم الحليم، لا إله إلا الله رب العرش العظيم، لا إله إلا الله رب السماوات ورب الأرض ورب العرش الكريم.', count: 1 },
            { text: 'اللهم رحمتك أرجو فلا تكلني إلى نفسي طرفة عين، وأصلح لي شأني كله، لا إله إلا أنت.', count: 1 },
            { text: 'يا حي يا قيوم برحمتك أستغيث.', count: 25 },
        ]
    },
    'azkar-tawba': {
        title: 'أذكار التوبة',
        azkar: [
            { text: 'استغفر الله العظيم الذي لا إله إلا هو الحي القيوم وأتوب إليه.', count: 25 },
            { text: 'اللهم أنت ربي لا إله إلا أنت، خلقتني وأنا عبدك، وأنا على عهدك ووعدك ما استطعت، أعوذ بك من شر ما صنعت، أبوء لك بنعمتك علي، وأبوء بذنبي فاغفر لي فإنه لا يغفر الذنوب إلا أنت.', count: 1 },
            { text: 'رب اغفر لي وارحمني وتب علي إنك أنت التواب الرحيم.', count: 100 },
            { text: 'لا إله إلا أنت سبحانك إني كنت من الظالمين.', count: 1 },
        ]
    }
};

const sections = [
    { name: 'أذكار الصباح', color: 'color-sunrise', icon: '☀️', id: 'azkar-sabah', type: 'azkar' },
    { name: 'أذكار المساء', color: 'color-moon', icon: '🌙', id: 'azkar-masaa', type: 'azkar' },
    { name: 'أذكار النوم', color: 'color-bed', icon: '😴', id: 'azkar-noom', type: 'azkar' },
    { name: 'أذكار الاستيقاظ', color: 'color-wake', icon: '🌅', id: 'azkar-estikaaz', type: 'azkar' },
    { name: 'أذكار الهم والحزن', color: 'color-sad', icon: '💔', id: 'azkar-ham', type: 'azkar' },
    { name: 'أذكار التوبة', color: 'color-hand', icon: '🤲', id: 'azkar-tawba', type: 'azkar' },
    { name: 'مواقيت الصلاة', color: 'color-mosque', icon: '🕌', id: 'prayer-times', type: 'prayer' },
    { name: 'تواصل معنا', color: 'color-contact', icon: '📞', id: 'contact', type: 'contact' }
];

let alarmIntervals = {};
let alarmState = JSON.parse(localStorage.getItem('alarmState')) || {
    'azkar-sabah': false,
    'azkar-masaa': false,
    'azkar-noom': false,
    'azkar-estikaaz': false,
};

function hideWelcomeScreen() {
    const welcomeScreen = document.getElementById('welcome-screen');
    const mainApp = document.getElementById('main-app');
    setTimeout(() => {
        welcomeScreen.style.opacity = '0';
        setTimeout(() => {
            welcomeScreen.style.display = 'none';
            mainApp.style.display = 'block';
        }, 1000);
    }, 2000);
}

function renderSections() {
    const sectionsContainer = document.querySelector('.sections-container');
    sectionsContainer.innerHTML = '';
    sections.forEach(section => {
        const card = document.createElement('div');
        card.className = 'section-card';
        card.id = section.id;
        const iconDiv = document.createElement('div');
        iconDiv.className = `icon ${section.color}`;
        iconDiv.textContent = section.icon;
        const title = document.createElement('h3');
        title.textContent = section.name;
        card.appendChild(iconDiv);
        card.appendChild(title);

        if (section.type === 'azkar' && section.id !== 'azkar-ham' && section.id !== 'azkar-tawba') {
            const alarmToggle = document.createElement('div');
            alarmToggle.className = 'alarm-toggle';
            const alarmButton = document.createElement('button');
            alarmButton.textContent = alarmState[section.id] ? 'إيقاف التذكير' : 'تفعيل التذكير';
            alarmButton.className = alarmState[section.id] ? '' : 'off';
            alarmButton.onclick = (e) => {
                e.stopPropagation();
                toggleAlarm(section.id);
            };
            alarmToggle.appendChild(alarmButton);
            card.appendChild(alarmToggle);
        }

        sectionsContainer.appendChild(card);
    });
}

function toggleAlarm(sectionId) {
    alarmState[sectionId] = !alarmState[sectionId];
    localStorage.setItem('alarmState', JSON.stringify(alarmState));
    renderSections();
    if (alarmState[sectionId]) {
        setAlarm(sectionId);
    } else {
        clearAlarm(sectionId);
    }
}

function setAlarm(sectionId) {
    const now = new Date();
    let alarmTime = new Date();

    if (sectionId === 'azkar-sabah') alarmTime.setHours(5, 0, 0, 0);
    else if (sectionId === 'azkar-estikaaz') alarmTime.setHours(7, 0, 0, 0);
    else if (sectionId === 'azkar-masaa') alarmTime.setHours(17, 0, 0, 0);
    else if (sectionId === 'azkar-noom') alarmTime.setHours(22, 0, 0, 0);

    if (alarmTime < now) {
        alarmTime.setDate(alarmTime.getDate() + 1);
    }

    const timeToAlarm = alarmTime.getTime() - now.getTime();
    
    alarmIntervals[sectionId] = setTimeout(() => {
        alert(`حان وقت ${sections.find(s => s.id === sectionId).name}`);
        setAlarm(sectionId);
    }, timeToAlarm);
}

function clearAlarm(sectionId) {
    if (alarmIntervals[sectionId]) {
        clearTimeout(alarmIntervals[sectionId]);
        delete alarmIntervals[sectionId];
    }
}

function createAzkarPage(section) {
    const contentContainer = document.getElementById('content-container');
    contentContainer.innerHTML = '';
    const backButton = document.createElement('button');
    backButton.textContent = 'رجوع';
    backButton.className = 'back-button';
    backButton.onclick = () => window.location.reload();
    const title = document.createElement('h2');
    title.textContent = section.name;
    title.style.textAlign = 'center';
    const azkarList = azkarData[section.id].azkar;
    const azkarContainer = document.createElement('div');
    azkarContainer.className = 'azkar-container';
    let currentAzkarIndex = 0;
    
    function renderCurrentAzkar() {
        azkarContainer.innerHTML = '';
        const currentAzkar = azkarList[currentAzkarIndex];
        if (!currentAzkar) {
            azkarContainer.innerHTML = `<p class="azkar-complete-message">تم الانتهاء من الأذكار. اضغط للعودة.</p>`;
            azkarContainer.onclick = () => window.location.reload();
            return;
        }
        
        const azkarText = document.createElement('p');
        azkarText.className = 'azkar-text';
        azkarText.textContent = currentAzkar.text;
        
        const counterDisplay = document.createElement('div');
        counterDisplay.className = 'counter-display';
        counterDisplay.textContent = currentAzkar.count;
        
        const counterButton = document.createElement('button');
        counterButton.className = 'counter-button';
        counterButton.textContent = 'تسبيح';
        
        let currentCount = 0;
        counterButton.onclick = () => {
            currentCount++;
            if (currentCount >= currentAzkar.count) {
                currentAzkarIndex++;
                renderCurrentAzkar();
            } else {
                counterDisplay.textContent = currentAzkar.count - currentCount;
            }
        };
        
        const skipButton = document.createElement('button');
        skipButton.className = 'skip-button';
        skipButton.textContent = 'تخطي';
        skipButton.onclick = () => {
            currentAzkarIndex++;
            renderCurrentAzkar();
        };

        azkarContainer.appendChild(azkarText);
        azkarContainer.appendChild(counterDisplay);
        azkarContainer.appendChild(counterButton);
        azkarContainer.appendChild(skipButton);
    }
    
    const container = document.createElement('div');
    container.className = 'section-page-content';
    container.appendChild(backButton);
    container.appendChild(title);
    container.appendChild(azkarContainer);
    contentContainer.appendChild(container);
    
    renderCurrentAzkar();
}

function fetchPrayerTimes() {
    const contentContainer = document.getElementById('content-container');
    contentContainer.innerHTML = '<p style="text-align: center;">يتم الآن جلب مواقيت الصلاة...</p>';
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            const { latitude, longitude } = position.coords;
            const url = `https://api.aladhan.com/v1/timingsByCity?city=Cairo&country=Egypt`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    createPrayerTimesPage(data.data.timings);
                })
                .catch(error => {
                    contentContainer.innerHTML = `<p style="text-align: center;">حدث خطأ أثناء جلب المواقيت.</p>`;
                });
        }, error => {
            contentContainer.innerHTML = `<p style="text-align: center;">لم يتمكن التطبيق من الوصول إلى موقعك.</p>`;
        });
    } else {
        contentContainer.innerHTML = `<p style="text-align: center;">المتصفح لا يدعم تحديد الموقع الجغرافي.</p>`;
    }
}

function format12Hour(time) {
    const [hour, minute] = time.split(':');
    let h = parseInt(hour);
    let ampm = h >= 12 ? 'م' : 'ص';
    h = h % 12;
    h = h ? h : 12; // the hour '0' should be '12'
    return `${h}:${minute} ${ampm}`;
}

function createPrayerTimesPage(timings) {
    const contentContainer = document.getElementById('content-container');
    contentContainer.innerHTML = '';
    const backButton = document.createElement('button');
    backButton.textContent = 'رجوع';
    backButton.className = 'back-button';
    backButton.onclick = () => window.location.reload();
    const title = document.createElement('h2');
    title.textContent = 'مواقيت الصلاة';
    title.style.textAlign = 'center';

    const prayerNames = {
        Fajr: 'الفجر',
        Dhuhr: 'الظهر',
        Asr: 'العصر',
        Maghrib: 'المغرب',
        Isha: 'العشاء'
    };

    const timingsList = document.createElement('ul');
    timingsList.className = 'prayer-time-list';
    
    for (const prayer in timings) {
        if (typeof timings[prayer] === 'string' && prayerNames[prayer]) {
            const listItem = document.createElement('li');
            listItem.textContent = `${prayerNames[prayer]}: ${format12Hour(timings[prayer])}`;
            timingsList.appendChild(listItem);
        }
    }
    const container = document.createElement('div');
    container.className = 'section-page-content';
    container.appendChild(backButton);
    container.appendChild(title);
    container.appendChild(timingsList);
    contentContainer.appendChild(container);
}

function showContactInfo() {
    const contentContainer = document.getElementById('content-container');
    contentContainer.innerHTML = '';
    const backButton = document.createElement('button');
    backButton.textContent = 'رجوع';
    backButton.className = 'back-button';
    backButton.onclick = () => window.location.reload();
    const contactSection = document.createElement('div');
    contactSection.className = 'contact-section';
    contactSection.innerHTML = `
        <h3>تواصل معنا</h3>
        <p>للشكاوى والاقتراحات: <strong>00201550243338</strong></p>
        <p>بريد إلكتروني: <strong>pzkt@outlook.com</strong></p>
        <p>للتبرع لدعم التطبيق وكسب الأجر يرجى التواصل على:</p>
        <p><a href="https://wa.me/+201550243338" target="_blank">wa.me/+201550243338</a></p>
    `;
    const container = document.createElement('div');
    container.className = 'section-page-content';
    container.appendChild(backButton);
    container.appendChild(contactSection);
    contentContainer.appendChild(container);
}

document.addEventListener('DOMContentLoaded', () => {
    hideWelcomeScreen();
    renderSections();
    Object.keys(alarmState).forEach(id => {
        if (alarmState[id]) {
            setAlarm(id);
        }
    });

    document.addEventListener('click', (event) => {
        const card = event.target.closest('.section-card');
        if (card) {
            const section = sections.find(s => s.id === card.id);
            if (section) {
                if (section.type === 'azkar') {
                    createAzkarPage(section);
                } else if (section.type === 'prayer') {
                    fetchPrayerTimes();
                } else if (section.type === 'contact') {
                    showContactInfo();
                }
            }
        }
    });
});
